name: Laravel Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo, tokenizer, xml, ctype, json

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          passphrase: ${{ secrets.CPANEL_SSH_PASSPHRASE }}
          port: 22
          script: |
            echo "ğŸš€ Starting deployment on server..."

            cd ${{ secrets.DEPLOY_PATH }} || exit 1
            echo "ğŸ“‚ Changed directory to $(pwd)"

            echo "ğŸ”„ Backing up .env file..."
            cp .env .env.backup || { echo "âš ï¸ No .env file found, skipping backup."; }

            echo "ğŸ”„ Fetching latest changes..."
            attempt=0
            max_attempts=3
            until git fetch origin main || [ $attempt -eq $max_attempts ]; do
              echo "âŒ Git fetch failed. Retrying... ($attempt)"
              ((attempt++))
              sleep 10
            done

            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ Git fetch failed after $max_attempts attempts!"
              exit 1
            fi

            echo "ğŸ”„ Resetting repository to latest commit..."
            git reset --hard origin/main || { echo "âŒ Git reset failed!"; exit 1; }

            echo "ğŸ”„ Restoring .env file..."
            cp .env.backup .env || { echo "âš ï¸ .env backup not found, skipping restore."; }

            echo "ğŸ“¦ Installing dependencies..."
            composer install --no-dev --optimize-autoloader || { echo "âŒ Composer install failed!"; exit 1; }

            echo "âš¡ Running Laravel optimizations..."
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "ğŸ› ï¸ Setting permissions..."
            chmod -R 775 storage bootstrap/cache
            chown -R $USER:www-data storage bootstrap/cache

            echo "ğŸš€ Restarting queues..."
            php artisan queue:restart

            echo "âœ… Deployment successful!"
